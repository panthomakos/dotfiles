# Passwords and personal information is stored in a GPG encrypted file.
#
# Example:
#     # $HOME/.gmail.gpg
#     set my_real_name = "First Last"
#     set my_personal_email = email@gmail.com
#     set my_personal_password = password
#     set my_personal_folder = imaps://email@imap.gmail.com
source "gpg --no-tty --use-agent -dq $HOME/.gpg/mutt.gpg |"

source $HOME/.mutt/colors
source $HOME/.mutt/personal.gmail

# Cache Configuration
set header_cache=~/.mutt/cache/headers
set message_cachedir=~/.mutt/cache/bodies

# Urgency Hook and Bells
set beep = yes
set beep_new = yes

# Use new IMAP connections to check for mail.
unset imap_passive
# Reasonable default for keeping IMAP connection alive.
set imap_keepalive = 300
# Check for new mail every 60 seconds.
set mail_check = 10

# Gmail already stores sent messages.
unset record
# Don't move read messages, I'll archive them instead.
unset move
# Don't delete messages, I'll move them to the trash instead.
set delete

# Index Display Options
#   %D - the date in `date_format`
#   %M - number of hidden messages if the thread is collapsed.
set index_format = "%4C %Z (%M) %D %-15.15L %s"
# Shorter date format.
set date_format = "%m/%d"
# Sort using threads, like Gmail does.
set sort = threads
# Sort in reverse chronological order.
set sort_aux = reverse-last-date-received
# Sort threads using subjects that match "Re:" format.
set sort_re
# Collapse all threads by default
folder-hook . "exec collapse-all"
# Speed up folder switching.
set sleep_time = 0

# Pager Options
# Automatically view text/html messages.
auto_view text/html
# Pad the end of a message with tildes.
set tilde
# Don't go to the next message.
unset resolve

# Contact Management
set query_command="abook --datafile ~/Dropbox/addressbook --mutt-query '%s'"
macro index,pager a "<pipe-message>abook --datafile ~/Dropbox/addressbook --add-email-quiet<return>" "Add Email"
bind editor <Tab> complete-query

# Composing Options
# Set VIM as the default editor.
set editor = "vim -S $HOME/.mutt/vim"
# Include attachments in outgoing messages.
set fcc_attach
# Include forwarded messages in the body instead of as a separate MIME.
unset mime_forward
# Forward format (%s is the message subject).
set forward_format = "Fwd: %s"
# Include a copy of the message I am replying to.
set include
# Forwarded message content will be quoted.
set forward_quote
# Fix weird line breaks.
set text_flowed = yes

# Account Switching Macros
macro index gp "<sync-mailbox><enter-command>source ~/.mutt/personal.gmail<enter><change-folder>!<enter>"
macro index gw "<sync-mailbox><enter-command>source ~/.mutt/work.gmail<enter><change-folder>!<enter>"

# View links in the pager using urlscan.
macro pager o "<pipe-entry> urlscan<enter>" 'View Links'

# Pager Movement Keys
bind pager gg top
bind pager G bottom
bind pager j next-line
bind pager k previous-line
bind pager / search
bind pager \cd half-down
bind pager \cu half-up

# Collapse all threads
bind index T collapse-all

# Tag all messages in a thread
bind index t tag-thread

# Folder Switching Macros
macro index gi "<change-folder>=INBOX<enter>" "Go to INBOX"
macro index gt "<change-folder>=[Gmail]/Trash<enter>" "Go to Trash"
macro index gs "<change-folder>=[Gmail]/Sent Mail<enter>" "Go to Sent Mail"
macro index gd "<change-folder>=[Gmail]/Drafts<enter>" "Go to Drafts"
macro index gx "<change-folder>=[Gmail]/Starred<enter>" "Go to Starred"

# Index Movement Macros
bind index gg first-entry
bind index G last-entry

# Toggle collapsing an individual thread.
bind index <space> collapse-thread
# Quick way to reply-all.
bind index,pager R group-reply

# Refresh/Sync
bind index U imap-fetch-mail
bind index x sync-mailbox

# Toggle ! important flag (equivalent to Gmail star).
bind index s flag-message

# Gmail Archive
#   This works exactly as Gmail's archive does. When a message is deleted the
#   IMAP Gmail equivalent is to archive it. In the pager view, first exit to the
#   index view and then archive the message.
macro index e "<delete-message>" "Archive"
macro pager e "<exit>e" "Archive"
macro index E "<tag-thread><tag-prefix>e" "Archive Thread"

# Gmail Delete
#   This works exactly as Gmail's delete does - by moving a message to the trash
#   folder. It then refreshes the index view and collapses all threads. In the
#   pager view, first exit to the index view and then delete the message.
macro index d \
  "<save-message>=[Gmail]/Trash<enter><enter><refresh><collapse-all>" \
  "Trash"
macro pager d "<exit>d" "Trash"
macro index D "<tag-thread><tag-prefix>d" "Trash Thread"

# Move to INBOX
macro index,pager i <save-message>=INBOX<enter><enter> "Move to inbox"
