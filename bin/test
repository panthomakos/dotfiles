#!/bin/bash

set -e

need_rails=''

if [ $# -gt 0 ]; then # we have args
    filename=$1
    # Remove trailing line numbers from filename, e.g. spec/my_spec.rb:33
    grep_filename=`echo $1 | sed 's/:.*$//g'`

    (set +e; grep -r 'require.*spec_helper' $grep_filename) > /dev/null
    if [ $? -eq 0 ]; then # no match; we have a stand-alone spec
        need_rails=1
    fi
else # we have no args
    filename='spec'
fi

command='rspec --color'


if [ -f bin/rspec ]; then
  command="bin/$command"
else
  command="bundle exec $command"
fi

if [ $need_rails ]; then
  command="$command --drb"
fi

echo "RAILS_ENV=test ${command} ${filename}"
RAILS_ENV=test $command $filename
